<!-- S3: Data Grid Section -->
<!-- This section displays irrigation records in a sortable table -->

<div class="s3-data-grid">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
        <h3 style="color: #2a5298; margin: 0;">ðŸ“Š Irrigation Data Grid</h3>
        <button 
            onclick="resetIrrigationData()"
            style="background: #ff9800; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 12px; font-weight: 600;">
            ðŸ”„ Reset Data
        </button>
    </div>
    
    <div id="recordCount" style="margin-bottom: 10px; color: #666; font-size: 14px;">
        Loading records...
    </div>
    
    <div style="overflow-x: auto; max-height: 300px; overflow-y: auto;">
        <table id="irrigationGrid" style="width: 100%; border-collapse: collapse; font-size: 12px;">
            <thead>
                <tr style="background: #2a5298; color: white; position: sticky; top: 0;">
                    <th style="padding: 8px; text-align: left; border: 1px solid #ddd;">Ranch</th>
                    <th style="padding: 8px; text-align: left; border: 1px solid #ddd;">Planting</th>
                    <th style="padding: 8px; text-align: left; border: 1px solid #ddd;">Date</th>
                    <th style="padding: 8px; text-align: left; border: 1px solid #ddd;">Rec Hrs</th>
                    <th style="padding: 8px; text-align: left; border: 1px solid #ddd;">Mgr Hrs</th>
                    <th style="padding: 8px; text-align: left; border: 1px solid #ddd;">Interval</th>
                    <th style="padding: 8px; text-align: left; border: 1px solid #ddd;">Applied</th>
                </tr>
            </thead>
            <tbody id="gridBody">
                <!-- Data rows will be inserted here -->
            </tbody>
        </table>
    </div>
</div>

<style>
/* Grid selection styles */
#gridBody tr:hover {
    background: #f5f5f5 !important;
    cursor: pointer;
}

#gridBody tr.selected {
    background: #E3F2FD !important;
    border-left: 4px solid #2196F3;
}
</style>

<script>
// S3 Grid Functions
function loadIrrigationGrid() {
    const tbody = document.getElementById('gridBody');
    const count = document.getElementById('recordCount');
    
    if (!tbody) return;
    
    tbody.innerHTML = '';
    const data = window.irrigationLocalStorage || [];
    
    data.forEach((record, index) => {
        const row = document.createElement('tr');
        row.dataset.recordId = 'record_' + index;
        row.onclick = function() { selectGridRow('record_' + index); };
        
        row.innerHTML = 
            '<td style="padding: 6px 8px; border-bottom: 1px solid #ddd;">' + (record.Ranch || '') + '</td>' +
            '<td style="padding: 6px 8px; border-bottom: 1px solid #ddd;">' + (record.Planting || '') + '</td>' +
            '<td style="padding: 6px 8px; border-bottom: 1px solid #ddd;">' + (record.Eventdate || '') + '</td>' +
            '<td style="padding: 6px 8px; border-bottom: 1px solid #ddd; text-align: center;">' + (record.RecommendedHours || '0') + '</td>' +
            '<td style="padding: 6px 8px; border-bottom: 1px solid #ddd; text-align: center;">' + (record.ManagerAmount || '0') + '</td>' +
            '<td style="padding: 6px 8px; border-bottom: 1px solid #ddd; text-align: center;">' + (parseFloat(record.RecommendedInterval) || 0) + ' days</td>' +
            '<td style="padding: 6px 8px; border-bottom: 1px solid #ddd; text-align: center; font-weight: ' + 
            (record.WaterApplied > 0 ? 'bold' : 'normal') + '; color: ' + 
            (record.WaterApplied > 0 ? '#4CAF50' : '#999') + ';">' + (record.WaterApplied || '0') + '</td>';
        
        tbody.appendChild(row);
    });
    
    if (count) {
        count.textContent = 'Showing ' + data.length + ' irrigation records';
    }
}

function selectGridRow(recordId) {
    // Remove previous selection styling
    const allRows = document.querySelectorAll('#gridBody tr');
    allRows.forEach(row => {
        row.classList.remove('selected');
        row.style.background = '';
        row.style.borderLeft = '';
    });
    
    // Add selection to clicked row
    const selectedRow = document.querySelector('[data-record-id="' + recordId + '"]');
    if (selectedRow) {
        selectedRow.classList.add('selected');
        selectedRow.style.background = '#E3F2FD';
        selectedRow.style.borderLeft = '4px solid #2196F3';
        
        // Update global selected record
        const index = parseInt(recordId.replace('record_', ''));
        window.selectedRecord = window.irrigationLocalStorage[index];
        
        console.log('Selected:', window.selectedRecord);
    }
}

function resetIrrigationData() {
    // Reset to original data
    window.irrigationLocalStorage = JSON.parse(JSON.stringify(window.irrigationFileStored));
    window.irrigationData = window.irrigationLocalStorage;
    
    // Sort after reset
    sortAndRefreshGrid();
    
    const s1Output = document.getElementById('s1-output');
    if (s1Output) {
        const timestamp = new Date().toLocaleTimeString();
        s1Output.innerHTML = 
            '<div style="color: #ff9800; font-weight: bold;">[' + timestamp + '] DATA RESET</div>' +
            '<div style="margin-left: 20px;">Grid reset to original ' + window.irrigationFileStored.length + ' records</div>' +
            '<div style="margin-left: 20px;">Sorted by Ranch â†’ Planting â†’ Date</div>';
    }
    
    // Auto-select first Ranch 1 Planting 1A record after reset
    setTimeout(() => {
        const data = window.irrigationLocalStorage;
        const ranch1Index = data.findIndex(r => 
            r.Ranch && r.Ranch.includes('Ranch 1') && 
            r.Planting && r.Planting.includes('1A')
        );
        
        if (ranch1Index >= 0) {
            selectGridRow('record_' + ranch1Index);
        }
    }, 100);
}

function sortAndRefreshGrid() {
    // Sort by Ranch â†’ Planting â†’ Date (oldest first)
    window.irrigationLocalStorage.sort((a, b) => {
        // First by Ranch
        if (a.Ranch < b.Ranch) return -1;
        if (a.Ranch > b.Ranch) return 1;
        
        // Then by Planting  
        if (a.Planting < b.Planting) return -1;
        if (a.Planting > b.Planting) return 1;
        
        // Finally by Date (ascending - oldest first)
        const dateA = new Date(a.Eventdate);
        const dateB = new Date(b.Eventdate);
        return dateA - dateB;
    });
    
    // Refresh the grid with sorted data
    loadIrrigationGrid();
}

window.refreshDataGrid = function() {
    loadIrrigationGrid();
};

// Initialize on load
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function() {
        sortAndRefreshGrid();
        
        setTimeout(() => {
            const data = window.irrigationLocalStorage;
            const ranch1Index = data.findIndex(r => 
                r.Ranch && r.Ranch.includes('Ranch 1') && 
                r.Planting && r.Planting.includes('1A')
            );
            
            if (ranch1Index >= 0) {
                selectGridRow('record_' + ranch1Index);
            }
        }, 200);
    });
} else {
    // Already loaded
    sortAndRefreshGrid();
    
    setTimeout(() => {
        const data = window.irrigationLocalStorage;
        const ranch1Index = data.findIndex(r => 
            r.Ranch && r.Ranch.includes('Ranch 1') && 
            r.Planting && r.Planting.includes('1A')
        );
        
        if (ranch1Index >= 0) {
            selectGridRow('record_' + ranch1Index);
        }
    }, 200);
}
</script>
